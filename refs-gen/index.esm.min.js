var g=class{ids={};index=0;id_prefix="id";clear(){this.ids={},this.index=0}getIdName(e){return this.ids[e]?this.ids[e]:(this.index++,this.ids[e]=`${this.id_prefix}_${this.index}`,this.ids[e])}getNameWrapper(e){return"${"+this.getIdName(e)+"}"}getNames(){return Object.keys(this.ids).map(n=>this.ids[n])}};var H="scope-ref",O="$",R="ref",d={scope_auto_name_prefix:O,scope_ref_attr_name:H,ref_attr_name:R,window:globalThis.window,is_scope_element:void 0,include_root:!1},m={};function y(r,e){var t;return e.is_scope_element?t=e.is_scope_element(r,e):t=r.getAttribute(e.scope_ref_attr_name),t===null?!1:t}function h(r={},e=!0){let t={scope_auto_name_prefix:m.scope_auto_name_prefix||d.scope_auto_name_prefix,scope_ref_attr_name:m.scope_ref_attr_name||d.scope_ref_attr_name,ref_attr_name:m.ref_attr_name||d.ref_attr_name,window:m.window||d.window,is_scope_element:m.is_scope_element||d.is_scope_element,include_root:m.include_root||d.include_root},n=Object.assign({},t,r);if(e&&!n.window)throw new Error("options.window is not defined");return n}function S(r,e,t={}){var n={},i={},s=[];let o=h(t);function a(l){var c=l.getAttribute(o.ref_attr_name);if(c!=null&&c!=""&&(n[c]?globalThis.window?console.warn(`Element has reference #${c} which is already used
`,`
element: `,l,`
reference #${c}: `,n[c],`
scope root: `,r):console.warn(`Element has reference #${c} which is already used
`):n[c]=l),l!=r){var u=y(l,o);if(typeof u!="string")return;u!=""?i[u]?(globalThis.window?console.warn(`scope #${u} is already used`,l):console.warn(`scope #${u} is already used`),s.push(l)):i[u]=l:s.push(l)}e&&e(l)}o.include_root===!0&&r instanceof o.window.HTMLElement&&(n.root=r,e&&e(r)),E(r,a,o);var p=0;let f=o.scope_auto_name_prefix;return s.forEach(l=>{for(;i[f+p.toString()];)p++;i[f+p.toString()]=l}),{refs:n,scope_refs:i}}function b(r,e,t){var n={};let i=h(t);function s(o){let a=o.getAttribute(i.ref_attr_name);a&&(e?e[a]&&(n[a]=o):n[a]=o)}return i.include_root===!0&&r instanceof i.window.HTMLElement&&(n.root=r),E(r,s,i),e&&T(n,e),n}function E(r,e,t){let n=h(t);function i(a){var p=a,f=p.parentElement;return f&&f!=r&&y(f,n)!==!1?2:1}let s=n.window.document.createTreeWalker(r,1,i);var o;for(n.include_root===!0&&r instanceof n.window.HTMLElement&&e(r);o=s.nextNode();)e(o)}function T(r,e){for(let t in e){let n=r[t];if(!n)throw new Error(`Missing ref: ${t}`);let i=typeof e[t]=="function"?e[t].prototype:e[t];if(i.isPrototypeOf(n)===!1)throw new Error(`The ref "${t}" must be an instance of ${i.constructor.name} (actual: ${n.constructor.name})`)}}var w=class r{#t=!1;#e;#r=!0;#n;#i;config;constructor(e,t){if(e==null)throw new Error("root_element is null");this.#e=e,this.config=h(t)}get root(){return this.#e}get refs(){return this.#r&&this.update(),this.#n}get scopes(){return this.#r&&this.update(),this.#i}update(e){if(this.#t)throw new Error("Object is already destroyed");let{refs:t,scope_refs:n}=S(this.#e,e,this.config);this.#n=t;let i={};for(let s in n)i[s]=new r(n[s],this.config);this.#i=i,this.#r=!1}querySelector(e){if(this.#t)throw new Error("Object is already destroyed");let t=this.querySelectorAll(e);return t.length==0?null:t[0]}querySelectorAll(e){if(this.#t)throw new Error("Object is already destroyed");var t=this.#e.querySelectorAll(e);if(t.length==0)return[];var n=[];for(let i=0;i<t.length;i++)this.contains(t[i],!0)&&n.push(t[i]);return n}contains(e,t=!1){if(this.#t)throw new Error("Object is already destroyed");if(t===!1&&!this.#e.contains(e))return!1;var n=this.scopes;for(let i in n){let s=n[i];if(s.#e==e)return!0;if(s.#e.contains(e))return!1}return!0}walk(e){if(this.#t)throw new Error("Object is already destroyed");E(this.#e,e,this.config)}destroy(){this.#t=!0,this.#e=null,this.#r=!1,this.#n={},this.#i={},this.config={}}isScopeElement(e){return!!y(e,this.config)}get isDestroyed(){return this.#t}checkRefs(e){if(this.#t)throw new Error("Object is already destroyed");T(this.refs,e)}};function v(r,e){if(typeof r!="string")throw new Error("html must be a string");let s=h(e).window.document.createElement("template");return s.innerHTML=r,s.content}function j(r){return r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.tagName==="SELECT"||r.tagName==="BUTTON"}function B(r){return r.hasAttribute("type")?r.getAttribute("type")||"unknown":r.tagName.toLowerCase()}function A(r){let e={};return new w(r).walk(n=>{if(j(n)){if(n.getAttribute("ref"))return;let s=B(n);e[s]||(e[s]=0),e[s]+=1,n.setAttribute("ref",`${s}_${e[s]}`)}}),r}function P(r,e){r.querySelectorAll("*[id]").forEach(i=>{let s=i.getAttribute("id");if(s){let o=e.getNameWrapper(s);i.setAttribute("id",o)}}),r.querySelectorAll("*[for]").forEach(i=>{let s=i.getAttribute("for");if(s){let o=e.getNameWrapper(s);i.setAttribute("for",o)}})}function F(r){return r.getNames().map(n=>`let ${n} = generateId();`).join(`
`)}function N(r){return`let html = /* html */ \`
${r}
\`;
`}function x(r,e){let t=document.createElement("template");t.innerHTML=r;let n=t.content,i=new g,s="";e.addRefsToInputs&&(n=A(n)),e.replaceIds&&(P(n,i),s=F(i).replace(/^/gm,"    "));let o=N(t.innerHTML),a=`
/**
 * @returns {string}
 */    
function getHtml() {

${s}

    ${o}
    return html;
}
    `.replace(/\n{3,}/g,`

`).trim();return{templateElement:t,getHTMLContent:a}}function W(r){let e=["const annotation = {"];for(let t in r)e.push(`    ${t}: ${r[t]},`);return e.push("};"),e.join(`
`)}function D(r){let e=["/**"," * @typedef {Object} Refs"];for(let t in r)e.push(` * @property {${r[t]}} ${t}`);return e.push("*/"),e.join(`
`)}function L(r){let e=b(r.content),t={};for(let s in e){let o=e[s];t[s]=o.constructor.name}let n=W(t);return`${D(t)}

${n}`}function $(r,e){let{templateElement:t,getHTMLContent:n}=x(r,e),i=L(t);return`// @ts-check
import { createFromHTML, selectRefs, generateId } from "dom-scope";

${n}

${i}

let fragment = createFromHTML(getHtml());
let refs = selectRefs(fragment, annotation);
document.body.append(fragment);
`}var _=class{events={};on(e,t){typeof this.events[e]!="object"&&(this.events[e]=[]),this.events[e].push(t);let n=this,i=function(){n.removeListener(e,t)};return!/^(#has-listeners|#no-listeners)$/.test(e)&&this.events[e].length==1&&this.emit("#has-listeners",e),i}removeListener(e,t){var n;typeof this.events[e]=="object"&&(n=this.events[e].indexOf(t),n>-1&&(this.events[e].splice(n,1),!/^(#has-listeners|#no-listeners)$/.test(e)&&this.events[e].length==0&&this.emit("#no-listeners",e)))}emit(e){if(typeof this.events[e]=="object"){var t,n,i,s=[].slice.call(arguments,1);for(n=this.events[e].slice(),i=n.length,t=0;t<i;t++)try{n[t].apply(this,s)}catch(o){console.error(e,s),console.error(o)}}}once(e,t){return this.on(e,function n(){this.removeListener(e,n),t.apply(this,arguments)})}waitForEvent(e,t=0){return new Promise(n=>{let i,s=this.on(e,()=>{t>0&&clearTimeout(i),s(),n(!0)});t>0&&(i=setTimeout(()=>{s(),n(!1)},t))})}waitForAnyEvent(e,t=0){return new Promise(n=>{let i,s=[],o=()=>{t>0&&clearTimeout(i),s.forEach(a=>{a()}),n(!0)};e.forEach(a=>{s.push(this.on(a,o))}),t>0&&(i=setTimeout(()=>{o(),n(!1)},t))})}clear(){this.events={}}destroy(){this.clear()}clearEventListeners(e){(this.events[e]||[]).length>0&&(this.events[e]=[],this.emit("#no-listeners",e))}onHasEventListeners(e){return this.on("#has-listeners",e)}onNoEventListeners(e){return this.on("#no-listeners",e)}};var C=new _;var G=v(`
<div class="container mt-5 mb-5">
    <h1 class="display-5" style="font-size: 24px;">Refs generator</h1>
    <div class="mb-1">
        <button class="btn btn-outline-secondary me-2" ref="beautifyButton">Beautify</button>
    </div>
    <div class="mb-3">
        <label for="input" class="form-label">Input HTML</label>
        <textarea class="form-control" rows="10" id="input" ref="inputTextArea"></textarea>
    </div>
    <div class="mb-3">
        <button class="btn btn-outline-secondary me-2" ref="clearAllButton">Clear all</button>
        <button class="btn btn-outline-secondary ms-4" ref="submitButton">Generate</button>
        <div class="form-check form-check-inline ms-3">
            <input class="form-check-input" type="checkbox" id="autoGenerate" ref="autoGenerateCheckbox">
            <label class="form-check-label" for="autoGenerate">Autogenerate refs for input elements</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="renameIds" ref="renameIdsCheckbox">
            <label class="form-check-label" for="renameIds">Rename Ids</label>
        </div>

    </div>
    <div class="mb-3">
        <label for="output" class="form-label">Output HTML</label>
        <textarea class="form-control" rows="10" id="output" ref="outputTextArea"></textarea>
    </div>
</div> 
`),q={inputTextArea:HTMLTextAreaElement,outputTextArea:HTMLTextAreaElement,submitButton:HTMLButtonElement,clearAllButton:HTMLButtonElement,autoGenerateCheckbox:HTMLInputElement,renameIdsCheckbox:HTMLInputElement,beautifyButton:HTMLButtonElement};function k(){document.body.append(G);let r=b(document.body,q);C.emit("connected",r)}function M(r){return C.on("connected",r)}function I(r){var e="	",t="",n="";return r.split(/>\s*</).forEach(function(i){i.match(/^\/\w/)&&(n=n.substring(e.length)),t+=n+"<"+i+`>\r
`,i.match(/^<?\w[^>]*[^\/]$/)&&!i.startsWith("input")&&(n+=e)}),t.substring(1,t.length-3)}M(r=>{r.submitButton.addEventListener("click",()=>{let e=r.inputTextArea.value;r.outputTextArea.value=$(e,{replaceIds:r.renameIdsCheckbox.checked,addRefsToInputs:r.autoGenerateCheckbox.checked})}),r.clearAllButton.addEventListener("click",()=>{r.inputTextArea.value="",r.outputTextArea.value=""}),r.beautifyButton.addEventListener("click",()=>{r.inputTextArea.value=I(r.inputTextArea.value)})});k();
