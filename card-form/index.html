<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bootstrap 5 Credit Card – Complete with Card Type Detection</title>
        <!-- Bootstrap 5 CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Bootstrap Icons -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
        />
        <style>
            input::-webkit-outer-spin-button,
            input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            input[type='number'] {
                -moz-appearance: textfield;
            }
        </style>
    </head>
    <body class="bg-light">
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="card shadow-sm">
                        <div class="card-body p-4">
                            <h3 class="card-title text-center mb-4">Payment Details</h3>
                            <form>
                                <!-- Card Number -->
                                <div class="mb-3">
                                    <label for="cardNumber" class="form-label">Card Number</label>
                                    <!-- Card type display -->
                                    <div id="cardTypeDisplay" class="small text-muted mb-1"></div>
                                    <div class="input-group">
                                        <span class="input-group-text"
                                            ><i class="bi bi-credit-card"></i
                                        ></span>
                                        <input
                                            type="text"
                                            inputmode="numeric"
                                            class="form-control"
                                            id="cardNumber"
                                            placeholder="1234 5678 9012 3456"
                                            aria-describedby="cardNumberHelp"
                                        />
                                        <span class="input-group-text">
                                            <i
                                                class="bi bi-check-circle-fill text-success d-none"
                                                id="cardValidIcon"
                                            ></i>
                                            <i
                                                class="bi bi-x-circle-fill text-danger d-none"
                                                id="cardInvalidIcon"
                                            ></i>
                                        </span>
                                    </div>
                                    <div id="cardNumberHelp" class="form-text">
                                        Enter the number on your card (16 digits for most cards, 15
                                        for Amex).
                                    </div>
                                </div>

                                <div class="row">
                                    <!-- Expiration Date -->
                                    <div class="col-md-6 mb-3">
                                        <label for="expiryDate" class="form-label"
                                            >Expiration Date</label
                                        >
                                        <div class="input-group">
                                            <span class="input-group-text"
                                                ><i class="bi bi-calendar"></i
                                            ></span>
                                            <input
                                                type="text"
                                                inputmode="numeric"
                                                class="form-control"
                                                id="expiryDate"
                                                placeholder="MM / YY"
                                                aria-describedby="expiryHelp"
                                            />
                                            <span class="input-group-text">
                                                <i
                                                    class="bi bi-check-circle-fill text-success d-none"
                                                    id="expiryValidIcon"
                                                ></i>
                                                <i
                                                    class="bi bi-x-circle-fill text-danger d-none"
                                                    id="expiryInvalidIcon"
                                                ></i>
                                            </span>
                                        </div>
                                        <div id="expiryHelp" class="form-text">MM / YY</div>
                                    </div>

                                    <!-- CVV -->
                                    <div class="col-md-6 mb-3">
                                        <label for="cvv" class="form-label">CVV</label>
                                        <div class="input-group">
                                            <span class="input-group-text"
                                                ><i class="bi bi-lock"></i
                                            ></span>
                                            <input
                                                type="text"
                                                inputmode="numeric" 
                                                class="form-control"
                                                id="cvv"
                                                placeholder="123"
                                                maxlength="4"
                                                aria-describedby="cvvHelp"
                                            />
                                            <span class="input-group-text">
                                                <i
                                                    class="bi bi-check-circle-fill text-success d-none"
                                                    id="cvvValidIcon"
                                                ></i>
                                                <i
                                                    class="bi bi-x-circle-fill text-danger d-none"
                                                    id="cvvInvalidIcon"
                                                ></i>
                                            </span>
                                        </div>
                                        <div id="cvvHelp" class="form-text">
                                            3 or 4 digits on the back of your card (4 for Amex).
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary w-100">Pay Now</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap 5 JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            (function () {
                const cardInput = document.getElementById('cardNumber');
                const expiryInput = document.getElementById('expiryDate');
                const cvvInput = document.getElementById('cvv');

                const cardValidIcon = document.getElementById('cardValidIcon');
                const cardInvalidIcon = document.getElementById('cardInvalidIcon');
                const expiryValidIcon = document.getElementById('expiryValidIcon');
                const expiryInvalidIcon = document.getElementById('expiryInvalidIcon');
                const cvvValidIcon = document.getElementById('cvvValidIcon');
                const cvvInvalidIcon = document.getElementById('cvvInvalidIcon');

                const cardTypeDisplay = document.getElementById('cardTypeDisplay');

                // ---- Card type detection ----
                function getCardType(digits) {
                    if (!digits || digits.length === 0) return '';
                    const firstTwo = digits.substring(0, 2);
                    const firstThree = digits.substring(0, 3);
                    const firstFour = digits.substring(0, 4);

                    // Visa
                    if (digits[0] === '4') return 'Visa';
                    // Mastercard (ranges: 51-55, 2221-2720)
                    if (/^5[1-5]/.test(digits)) return 'Mastercard';
                    if (parseInt(firstFour) >= 2221 && parseInt(firstFour) <= 2720)
                        return 'Mastercard';
                    // American Express
                    if (firstTwo === '34' || firstTwo === '37') return 'American Express';
                    // Discover
                    if (
                        firstFour === '6011' ||
                        /^65/.test(digits) ||
                        (parseInt(firstThree) >= 644 && parseInt(firstThree) <= 649)
                    )
                        return 'Discover';
                    // JCB
                    if (/^35/.test(digits)) return 'JCB';
                    // Diners Club
                    if (
                        firstTwo === '36' ||
                        firstTwo === '38' ||
                        (parseInt(firstThree) >= 300 && parseInt(firstThree) <= 305)
                    )
                        return 'Diners Club';
                    // UnionPay
                    if (/^62/.test(digits)) return 'UnionPay';
                    // Default
                    return 'Unknown';
                }

                function updateCardTypeDisplay(digits) {
                    const type = getCardType(digits);
                    if (type) {
                        cardTypeDisplay.textContent = `Card type: ${type}`;
                    } else {
                        cardTypeDisplay.textContent = '';
                    }
                }

                // ---- Luhn algorithm ----
                function luhnChecksum(code) {
                    var len = code.length;
                    var parity = len % 2;
                    var sum = 0;
                    for (let i = len - 1; i >= 0; i--) {
                        let d = parseInt(code.charAt(i));
                        if (i % 2 == parity) {
                            d *= 2;
                        }
                        if (d > 9) {
                            d -= 9;
                        }
                        sum += d;
                    }
                    return sum % 10;
                }

                function luhnValidate(fullcode) {
                    fullcode = fullcode.replace(/[^0-9]/g, '');
                    if (fullcode.length < 2) {
                        return false;
                    }
                    return luhnChecksum(fullcode) === 0;
                }

                // ---- Amex detection ----
                function isProbablyAmex(digits) {
                    return (
                        digits.length >= 2 && (digits.startsWith('34') || digits.startsWith('37'))
                    );
                }

                // ---- Format card number with dynamic grouping ----
                function formatCardNumber(input) {
                    const oldValue = input.value;
                    const cursorPos = input.selectionStart;

                    let digits = oldValue.replace(/\D/g, '');
                    const isAmex = isProbablyAmex(digits);
                    const maxDigits = isAmex ? 15 : 16;
                    digits = digits.substring(0, maxDigits);
                    const digitsBeforeCursor = oldValue
                        .slice(0, cursorPos)
                        .replace(/\D/g, '').length;

                    let formatted = '';
                    if (isAmex) {
                        const groups = [4, 6, 5];
                        let digitIndex = 0;
                        for (let i = 0; i < groups.length; i++) {
                            const groupSize = groups[i];
                            for (let j = 0; j < groupSize; j++) {
                                if (digitIndex < digits.length) {
                                    formatted += digits[digitIndex];
                                    digitIndex++;
                                }
                            }
                            if (digitIndex < digits.length && i < groups.length - 1) {
                                formatted += ' ';
                            }
                        }
                    } else {
                        for (let i = 0; i < digits.length; i++) {
                            if (i > 0 && i % 4 === 0) {
                                formatted += ' ';
                            }
                            formatted += digits[i];
                        }
                    }

                    input.value = formatted;

                    let newCursorPos = 0;
                    let digitCount = 0;
                    while (newCursorPos < formatted.length && digitCount < digitsBeforeCursor) {
                        if (/\d/.test(formatted[newCursorPos])) {
                            digitCount++;
                        }
                        newCursorPos++;
                    }
                    if (digitCount < digitsBeforeCursor) {
                        newCursorPos = formatted.length;
                    }
                    input.setSelectionRange(newCursorPos, newCursorPos);
                }

                // ---- Validate card number via Luhn ----
                function validateAndUpdateCardStatus(input) {
                    const digits = input.value.replace(/\D/g, '');
                    const isAmex = isProbablyAmex(digits);
                    const maxDigits = isAmex ? 15 : 16;

                    input.classList.remove('is-valid', 'is-invalid');
                    cardValidIcon.classList.add('d-none');
                    cardInvalidIcon.classList.add('d-none');

                    if (digits.length < maxDigits) return;

                    const isValid = luhnValidate(digits);
                    if (isValid) {
                        input.classList.add('is-valid');
                        cardValidIcon.classList.remove('d-none');
                    } else {
                        input.classList.add('is-invalid');
                        cardInvalidIcon.classList.remove('d-none');
                    }
                }

                // ---- Format expiry as MM / YY ----
                function formatExpiry(input) {
                    const cursorPos = input.selectionStart;
                    const oldValue = input.value;

                    let digits = oldValue.replace(/\D/g, '').substring(0, 4);
                    const digitsBeforeCursor = oldValue
                        .slice(0, cursorPos)
                        .replace(/\D/g, '').length;

                    let formatted = '';
                    if (digits.length > 0) {
                        if (digits.length <= 2) {
                            formatted = digits;
                        } else {
                            formatted = digits.substring(0, 2) + ' / ' + digits.substring(2, 4);
                        }
                    }

                    input.value = formatted;

                    let newCursorPos = 0;
                    let digitCount = 0;
                    while (newCursorPos < formatted.length && digitCount < digitsBeforeCursor) {
                        if (/\d/.test(formatted[newCursorPos])) {
                            digitCount++;
                        }
                        newCursorPos++;
                    }
                    if (digitCount < digitsBeforeCursor) {
                        newCursorPos = formatted.length;
                    }
                    input.setSelectionRange(newCursorPos, newCursorPos);
                }

                // ---- Validate expiry date (MM/YY) ----
                function validateExpiry(input) {
                    const digits = input.value.replace(/\D/g, '');
                    input.classList.remove('is-valid', 'is-invalid');
                    expiryValidIcon.classList.add('d-none');
                    expiryInvalidIcon.classList.add('d-none');

                    if (digits.length < 4) return;

                    const month = parseInt(digits.substring(0, 2), 10);
                    const year = parseInt(digits.substring(2, 4), 10) + 2000;

                    if (month < 1 || month > 12) {
                        input.classList.add('is-invalid');
                        expiryInvalidIcon.classList.remove('d-none');
                        return;
                    }

                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth() + 1;

                    const currentTotal = currentYear * 12 + currentMonth;
                    const inputTotal = year * 12 + month;
                    const maxTotal = (currentYear + 10) * 12 + currentMonth;

                    if (inputTotal < currentTotal) {
                        input.classList.add('is-invalid');
                        expiryInvalidIcon.classList.remove('d-none');
                    } else if (inputTotal > maxTotal) {
                        input.classList.add('is-invalid');
                        expiryInvalidIcon.classList.remove('d-none');
                    } else {
                        input.classList.add('is-valid');
                        expiryValidIcon.classList.remove('d-none');
                    }
                }

                // ---- Format CVV: only digits ----
                function formatCvv(input) {
                    const oldValue = input.value;
                    const cursorPos = input.selectionStart;
                    const digits = oldValue.replace(/\D/g, '');
                    const newValue = digits.substring(0, 4);
                    input.value = newValue;

                    if (cursorPos <= newValue.length) {
                        input.setSelectionRange(cursorPos, cursorPos);
                    } else {
                        input.setSelectionRange(newValue.length, newValue.length);
                    }
                }

                // ---- Validate CVV based on card type ----
                function validateCvv(input) {
                    const digits = input.value.replace(/\D/g, '');
                    const cardDigits = cardInput.value.replace(/\D/g, '');
                    const isAmex = isProbablyAmex(cardDigits);
                    const expectedLength = isAmex ? 4 : 3;

                    input.classList.remove('is-valid', 'is-invalid');
                    cvvValidIcon.classList.add('d-none');
                    cvvInvalidIcon.classList.add('d-none');

                    if (digits.length === 0) return;

                    if (digits.length === expectedLength) {
                        input.classList.add('is-valid');
                        cvvValidIcon.classList.remove('d-none');
                    } else {
                        input.classList.add('is-invalid');
                        cvvInvalidIcon.classList.remove('d-none');
                    }
                }

                // ---- Event listeners ----
                cardInput.addEventListener('input', function () {
                    formatCardNumber(this);
                    validateAndUpdateCardStatus(this);
                    validateCvv(cvvInput);
                    // Обновляем отображение типа карты
                    const digits = this.value.replace(/\D/g, '');
                    updateCardTypeDisplay(digits);
                });

                expiryInput.addEventListener('input', function () {
                    formatExpiry(this);
                    validateExpiry(this);
                });

                cvvInput.addEventListener('input', function () {
                    formatCvv(this);
                    validateCvv(this);
                });

                // Инициализация
                updateCardTypeDisplay(cardInput.value.replace(/\D/g, ''));
                validateCvv(cvvInput);
            })();
        </script>
    </body>
</html>
